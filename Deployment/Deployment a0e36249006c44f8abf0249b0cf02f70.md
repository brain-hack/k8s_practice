# Deployment

# Deployment ì‚¬ìš©í•˜ê¸°

replicasetë§Œ ì‚¬ìš©í•´ë„ ì¶©ë¶„íˆ MSAêµ¬ì¡°ì˜ ì»¨í…Œì´ë„ˆë¥¼ êµ¬ì„±í•  ìˆ˜ ìˆì„ ê±° ê°™ì§€ë§Œ, ì‹¤ì œ k8s ìš´ì˜ í™˜ê²½ì—ì„œ replicasetì„ yaml íŒŒì¼ì—ì„œ ì‚¬ìš©í•˜ëŠ” ê²½ìš°ëŠ” ê±°ì˜ ì—†ìŠµë‹ˆë‹¤. 

ëŒ€ë¶€ë¶„ì€ replicasetê³¼ podì˜ ì •ë³´ë¥¼ ì •ì˜í•˜ëŠ” deploymentë¼ëŠ” ì´ë¦„ì˜ ì˜¤ë¸Œì íŠ¸ë¥¼ yaml íŒŒì¼ì— ì •ì˜í•´ ì‚¬ìš©í•˜ë©°, deploymentëŠ” ì•ìœ¼ë¡œ ì—¬ëŸ¬ë¶„ì´ podì™€ í•¨ê»˜ ê°€ì¥ ë§ì´ ë³´ê²Œ ë  ì˜¤ë¸Œì íŠ¸ì´ê¸°ë„ í•©ë‹ˆë‹¤.

deploymentëŠ” replicasetì˜ ìƒìœ„ ì˜¤ë¸Œì íŠ¸ì´ê¸° ëŒ€ë¬¸ì— deploymentë¥¼ ìƒì„±í•˜ë©´ í•´ë‹¹ deploymentì— ëŒ€ì‘í•˜ëŠ” replicasetë„ í•¨ê»˜ ìƒì„±ë©ë‹ˆë‹¤. ë”°ë¼ì„œ deploymentë¥¼ ì‚¬ìš©í•˜ë©´ podì™€ replicasetì„ ì§ì ‘ ìƒì„±í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤. 

```bash
vi k8s_yaml/deployment-nginx.yaml
```

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-nginx-deployment
spec:
  replicas: 3
  selector:
    matchLabels:
      app: my-nginx
  template:
    metadata:
      name: my-nginx-pod
      labels:
        app: my-nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.10
        ports:
        - containerPort: 80
```

ìœ„ì— yaml íŒŒì¼ì˜ ë‚´ìš©ì„ í›‘ì–´ë³´ë©´ ë‹¨ì§€ kind ê°€ deploymentë¡œ ë°”ë€Œì—ˆì„ ë¿, replicasetì˜ yaml íŒŒì¼ì—ì„œ ë³€ê²½ëœ ë¶€ë¶„ì€ ê±°ì˜ ì—†ì–´ ë³´ì…ë‹ˆë‹¤. 

ìœ„ì˜ yamlë¡œ deploymentë¥¼ ìƒì„±í•´ë³´ê² ìŠµë‹ˆë‹¤.

```bash
kubectl apply -f k8s_yaml/deployment-nginx.yaml
```

![Untitled](Deployment%20a0e36249006c44f8abf0249b0cf02f70/Untitled.png)

```bash
kubectl get deploy
```

![Untitled](Deployment%20a0e36249006c44f8abf0249b0cf02f70/Untitled%201.png)

my-nginx-deployment ë¼ëŠ” ì´ë¦„ì˜ deploymentê°€ ìƒì„±ë¼ ìˆìœ¼ë©°, READYí•­ëª©ì˜ 3.3ì´ë¼ëŠ” ì¶œë ¥ì„ í†µí•´ 3ê°œì˜ podê°€ ì •ìƒì ìœ¼ë¡œ ì¤€ë¹„ëìŒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì¼ì • ê°œìˆ˜ì˜ podê°€ ìœ ì§€ë˜ë„ë¡ ìƒì„±í•˜ëŠ” ê²ƒì€ replicasetì´ê¸° ë•Œë¬¸ì— ì‹¤ì œë¡œëŠ” deploymentì™€ í•¨ê»˜ replicaset ë˜í•œ ìƒì„±ë¼ ìˆì„ ê²ƒì…ë‹ˆë‹¤. 

```bash
kubectl get replicasets
```

![Untitled](Deployment%20a0e36249006c44f8abf0249b0cf02f70/Untitled%202.png)

```bash
kubectl get pods
```

![Untitled](Deployment%20a0e36249006c44f8abf0249b0cf02f70/Untitled%203.png)

<aside>
ğŸ’¡ deploymentë¡œë¶€í„° ìƒì„±ëœ replicasetê³¼ podëŠ” íŠ¹ì´í•œ í•´ì‹œê°’ì„ í¬í•¨í•œ ì´ë¦„ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤.
ì´ í•´ì‹œê°’ì„ podë¥¼ ì •ì˜í•˜ëŠ” templateìœ¼ë¡œë¶€í„° ìƒì„±ëœ ê²ƒìœ¼ë¡œ, ì´ í•´ì‹œê°’ì— ëŒ€í•´ì„œëŠ” ë’¤ì—ì„œ ë‹¤ì‹œ ì„¤ëª…í•©ë‹ˆë‹¤.

</aside>

![Untitled](Deployment%20a0e36249006c44f8abf0249b0cf02f70/Untitled%204.png)

deploymentë¥¼ ìƒì„±í•¨ìœ¼ë¡œì¨ replicasetì´ ìƒì„±ëê³  replicasetì´ podë¥¼ ìƒì„±

ë”°ë¼ì„œ deploymentë¥¼ ì‚­ì œí•˜ë©´ replicasetì´ ì‚­ì œë˜ê³  replicasetì´ ì‚­ì œë˜ë©´ podê¹Œì§€ ì‚­ë‹¤ ì‚­ì œë©ë‹ˆë‹¤. 

# Deploymentë¥¼ ì‚¬ìš©í•˜ëŠ” ì´ìœ 

replicasetë§Œìœ¼ë¡œë„ ì¼ì • ê°œìˆ˜ì˜ podë¥¼ ì¶©ë¶„íˆ ìœ ì§€í•  ìˆ˜ ìˆëŠ”ë°ë„ 
deploymentë¥¼ ì‚¬ìš©í•´ ê°„ì ‘ì ìœ¼ë¡œ replicasetì„ ìƒì„±í•´ì•¼ í•  ì´ìœ 

- appì˜ ì—…ë°ì´íŠ¸ì™€ ë°°í¬ë¥¼ ë”ìš± í¸í•˜ê²Œ ë§Œë“¤ê¸° ìœ„í•´
- deploymentëŠ” container appì„ ë°°í¬í•˜ê³  ê´€ë¦¬í•˜ëŠ” ì—­í• ì„ ë‹´ë‹¹
- app ì—…ë°ì´íŠ¸í•  ë•Œ replicasetì˜ ë³€ê²½ ì‚¬í•­ì„ ì €ì¥í•˜ëŠ” revisionì„ ë‚¨ê²¨ ë¡¤ë°±ì„ ê°€ëŠ¥í•˜ê²Œ í•´ì¤Œ
- ë¬´ì¤‘ë‹¨ ì„œë¹„ìŠ¤ë¥¼ ìœ„í•´ podì˜ ë¡¤ë§ ì—…ë°ì´íŠ¸ì˜ ì „ëµì„ ì§€ì •í•  ìˆ˜ë„ ìˆìŒ

ë²„ì „ì„ ì—…ë°ì´íŠ¸í•˜ëŠ” ì˜ˆ

ìœ„ì—ì„œ ì‚¬ìš©í•œ yaml íŒŒì¼ì¸ k8s_yaml/deployment-nginx.yaml íŒŒì¼ë¡œ deploymentë¥¼ ìƒì„±í•˜ë˜ ì´ë²ˆì—ëŠ” â€”recordë¼ëŠ” íŠ¹ìˆ˜í•œ ì˜µì…˜ì„ ì‚¬ìš©

```bash
kubectl delete -f k8s_yaml/deployment-nginx.yaml
kubectl apply -f k8s_yaml/deployment-nginx.yaml --record
```

![Untitled](Deployment%20a0e36249006c44f8abf0249b0cf02f70/Untitled%205.png)

container appì˜ ë²„ì „ì´ ì—…ë°ì´íŠ¸ë˜ì–´ podì˜ ì´ë¯¸ì§€ë¥¼ ë³€ê²½í•´ì•¼ í•œë‹¤ê³  ê°€ì •í•´ë³´ê² ìŠµë‹ˆë‹¤. 

ì´ë•Œ deploymentì—ì„œ ìƒì„±ëœ podì˜ ì´ë¯¸ì§€ë¥¼ ë³€ê²½í•  ë•ŒëŠ” kubectl set image ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ podì˜ imageì˜ ë²„ì „ì„ nginx:1.11ìœ¼ë¡œ ë³€ê²½í•˜ë ¤ë©´ ë‹¤ìŒê³¼ ê°™ì´ ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•˜ë©´ ë©ë‹ˆë‹¤. 

```bash
kubectl get image deployment my-nginx-deployment nginx=nginx:1.11 --record
```

![Untitled](Deployment%20a0e36249006c44f8abf0249b0cf02f70/Untitled%206.png)

nginx=nginx:1.11ì€ pod templateì— ì •ì˜ëœ cotainers í•­ëª©ì—ì„œ nginxë¼ëŠ” ì´ë¦„ì„ ê°€ì§€ëŠ” ì»¨í…Œì´ë„ˆì˜ ì´ë¯¸ì§€ë¥¼ nginx:1.11ìœ¼ë¡œ ë³€ê²½í•©ë‹ˆë‹¤.

<aside>
ğŸ’¡ yamlíŒŒì¼ì„ ìˆ˜ì • í›„ apply ëª…ë ¹ì„ ì´ìš©í•´ë„ ë˜ê³  kubectl edit ëª…ë ¹ì„ ì´ìš©í•´ë„ ë©ë‹ˆë‹¤.

</aside>

ë‹¤ì‹œ podì˜ ëª©ë¡ì„ í™•ì¸í•´ë³´ë©´ ë°©ê¸ˆ ì „ì— ì´ë¯¸ì§€ë¥¼ updateí•¨ìœ¼ë¡œì¨ ìƒˆë¡­ê²Œ ìƒì„±ëœ podë“¤ì´ ì¡´ì¬í•©ë‹ˆë‹¤.

```bash
kubectl get pods
```

![Untitled](Deployment%20a0e36249006c44f8abf0249b0cf02f70/Untitled%207.png)

![Untitled](Deployment%20a0e36249006c44f8abf0249b0cf02f70/Untitled%208.png)

![Untitled](Deployment%20a0e36249006c44f8abf0249b0cf02f70/Untitled%209.png)

ì„œì„œíˆ êµì²´ë˜ê³  ìˆìŠµë‹ˆë‹¤.

replicasetì˜ ëª©ë¡ì„ ì¶œë ¥í•´ë³´ë©´ ë¬´ì—‡ì´ ì¶œë ¥ë ê¹Œìš”?

```bash
kubectl get rs
```

![Untitled](Deployment%20a0e36249006c44f8abf0249b0cf02f70/Untitled%2010.png)

ì´ìƒí•˜ê²Œë„ replicasetì´ ë‘ê°œê°€ ìˆìŠµë‹ˆë‹¤. 

DESIRED, CURRENT ë“±ì˜ í•­ëª©ì´ 3ìœ¼ë¡œ í‘œì‹œëœ my-nginx-deployment-778db9c89d replicasetì€ ì´ë¯¸ì§€ë¥¼ ì—…ë°ì´íŠ¸í•¨ìœ¼ë¡œì¨ ë°©ê¸ˆ ìƒˆë¡­ê²Œ ìƒì„±ëœ replicasetì…ë‹ˆë‹¤. ë‹¤ë¥¸ í•˜ë‚˜ëŠ” replicasetì´ 0dmfh tjfwjdehl podë¥¼ ìƒì„±í•˜ì§€ëŠ” ì•Šê³  ìˆì§€ë§Œ ê¸°ì¡´ì˜ replicasetì„ì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

deploymentëŠ” podì˜ ì •ë³´ë¥¼ ì—…ë°ì´íŠ¸í•¨ìœ¼ë¡œì¨ ìƒˆë¡œìš´ replicasetê³¼ ì½”ë“œë¥¼ ìƒì„±í–ˆìŒì—ë„ ë¶ˆêµ¬í•˜ê³  ì´ì „ ë²„ì „ì˜ replicasetì„ ì‚­ì œí•˜ì§€ ì•Šê³  ë‚¨ê²¨ë‘ê³  ìˆìŠµë‹ˆë‹¤. ì¦‰, deploymentëŠ” podì˜ ì •ë³´ê°€ ë³€ê²½ë˜ì–´ updateê°€ ë°œìƒˆì•´ì„ ë•Œ, ì´ì „ì˜ ì •ë³´ë¥¼ revisionìœ¼ë¡œ ë³´ì¡´í•©ë‹ˆë‹¤. ì´ëŸ¬í•œ revision ì •ë³´ëŠ” ë‹¤ìŒ ëª…ë ìœ¼ë¡œ í™•ì¸ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.

```bash
kubectl rollout history deployment my-nginx-deployment
```

![Untitled](Deployment%20a0e36249006c44f8abf0249b0cf02f70/Untitled%2011.png)

â€”record=true ì˜µì…˜ìœ¼ë¡œ deploymentë¥¼ ë³€ê²½í•˜ë©´ ë³€ê²½ì‚¬í•­ì„ ìœ„ì™€ ê°™ì´ deploymentì— ê¸°ë¡í•¨ìœ¼ë¡œì¨ í•´ë‹¹ ë²„ì „ì˜ replicasetì„ ë³´ì¡´í•©ë‹ˆë‹¤.

<aside>
ğŸ’¡ â€”record ì˜µì…˜ì´ ì•„ë‹ˆì–´ë„ ë³´ì¡´ì€ ë  ìˆ˜ ì‡ìœ¼ë‚˜ ì–´ë–¤ ëª…ë ¹ì„ í†µí•´ ë³€ê²½ë˜ì—ˆëŠ”ì§€ ê¸°ë¡í•˜ëŠ” CHANGE-CAUSE í•­ëª©ì´ NONEìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.
ì™ ë§Œí•˜ë©´ â€”record ì“°ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.

</aside>

ë§Œì•½ì— ì´ì „ ë²„ì „ì˜ replicasetìœ¼ë¡œ ë˜ëŒë¦¬ëŠ” ë¡¤ë°±ì„ í•˜ê³  ì‹¶ë‹¤ë©´ 

```bash
kubectl rollout undo deployment my-nginx-deployment --to-revision=1
```

![Untitled](Deployment%20a0e36249006c44f8abf0249b0cf02f70/Untitled%2012.png)

ë‹¤ì‹œ replicasetì˜ ëª©ë¡ì„ í™•ì¸

```bash
kubectl get rs
```

![Untitled](Deployment%20a0e36249006c44f8abf0249b0cf02f70/Untitled%2013.png)

ì²˜ìŒì— ìƒì„±í–ˆë˜ replicasetì´ ë‹¤ì‹œ 3ê°œì˜ podë¥¼ ìƒì„±í•˜ê³  ìˆëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë‚˜ì¤‘ì—ì„œ ìƒì„±í–ˆë˜ replicasetì˜ podëŠ” 0ìœ¼ë¡œ ì¤„ì–´ë“¤ì–´ ìˆìŠµë‹ˆë‹¤.

<aside>
ğŸ’¡ pod templateìœ¼ë¡œë¶€í„° ê³„ì‚°ëœ hashê°’ì€ ê° replicasetì˜ label selectorì—ì„œ pod-template-hashë¼ëŠ” ì´ë¦„ì˜ ë¼ë²¨ê°’ìœ¼ë¡œì„œ ìë™ìœ¼ë¡œ ì„¤ì •ë©ë‹ˆë‹¤. ë”°ë¼ì„œ ì—¬ëŸ¬ ê°œì˜ replicasetì€ ê²¹ì¹˜ì§€ ì•ŠëŠ” ë¼ë²¨ì„ í†µí•´ podë¥¼ ìƒì„±í•˜ê²Œ ë©ë‹ˆë‹¤.

```bash
kubectl get replicasets --show-labels
```

![Untitled](Deployment%20a0e36249006c44f8abf0249b0cf02f70/Untitled%2014.png)

</aside>

kubernetes ë¦¬ì†ŒìŠ¤ì˜ ìì„¸í•œ ì •ë³´ë¥¼ ì¶œë ¥í•˜ëŠ” kubectl describe ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•´ deploymentì˜ ì •ë³´ë¥¼ ì¶œë ¥í•´ ë³´ë©´ í˜„ì¬ì˜ replicaset revision ì •ë³´ì™€ í™œì„±í™”ëœ replicaset ì´ë¦„ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. 

```bash
kubectl describe deploy my-nginx-deployment
```

![Untitled](Deployment%20a0e36249006c44f8abf0249b0cf02f70/Untitled%2015.png)

ì´ì²˜ëŸ¼ deploymentëŠ” ì—¬ëŸ¬ ê°œì˜ replicasetì„ ê´€ë¦¬í•˜ê¸° ìœ„í•œ ìƒìœ„ ì˜¤ë¸Œì íŠ¸ì…ë‹ˆë‹¤.  

deploymentë¥¼ ì‚¬ìš©í•˜ë©´ ì´ëŸ¬í•œ replicasetì˜ revision ê´€ë¦¬ ë¿ë§Œ ì•„ë‹ˆë¼ ë‹¤ì–‘í•œ podì˜ rolling udpate ì •ì±…ì„ ì‚¬ìš©í•  ìˆ˜ë„ ìˆë‹¤ëŠ” ì¥ì ì´ ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ kubernetesì—ì„œë„ ê³µì‹ì ìœ¼ë¡œ deploymentë¥¼ ì‚¬ìš©í•  ê²ƒì„ ê¶Œì¥í•˜ê³  ìˆìŠµë‹ˆë‹¤. 

ê·¸ëŸ¬ë‚˜ ì§€ê¸ˆ ë‹¹ì¥ replicasetì˜ revision ë° rolling updateì™€ ê´€ë ¨ëœ ëª…ë ¹ì–´ë¥¼ ê¸°ì–µí•  í•„ìš”ëŠ” ì—†ìŠµë‹ˆë‹¤.

deploymentì˜ ê¸°ëŠ¥ì„ ì´ìš©í•œ rolling updateì „ëµì€ ë’¤ì—ì„œ ì„¤ëª…í•  ê²ƒì…ë‹ˆë‹¤.

### ë¦¬ì†ŒìŠ¤ ì •ë¦¬

ì´ë²ˆ ì‹¤ìŠµì—ì„œ ìƒì„±í•œ ë¦¬ì†ŒìŠ¤ê°€ ë‚¨ì•„ìˆë‹¤ë©´ ì´ë¥¼ ëª¨ë‘ ì‚­ì œí•´ì£¼ì„¸ìš”

```bash
kubectl delete deployment,pod,rs --all
```

![Untitled](Deployment%20a0e36249006c44f8abf0249b0cf02f70/Untitled%2016.png)