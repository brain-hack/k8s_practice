# Service

ë””í”Œë¡œì´ë¨¼íŠ¸ë¥¼ í†µí•´ ìƒì„±ëœ íŒŒë“œì— ì–´ë–»ê²Œ ì ‘ê·¼í•  ìˆ˜ ìˆì„ê¹Œ?

### Serviceì˜ í•„ìš”ì„±

podì˜ ipë¡œ ì§ì ‘ ì ‘ê·¼ â‡’ ë™ì¼ ëŒ€ì—­í­ ë¡œì»¬ ê°œë°œ í™˜ê²½ ë˜ëŠ” kubernetes clusterë‚´ë¶€ì—ì„œë§Œ ê°€ëŠ¥

ì»¨í…Œì´ë„ˆ IPì™€ ë§ˆì°¬ê°€ì§€ë¡œ podì˜ IPëŠ” ì˜ì†ì ì´ê³  ê³ ì •ì ì´ì§€ ì•Šì•„ í•­ìƒ ë³€í•  ìˆ˜ ìˆìŒ

ì—¬ëŸ¬ ê°œì˜ deploymentë¥¼ í•˜ë‚˜ì˜ ì™„ë²½í•œ ì•±ìœ¼ë¡œ ì—°ë™
â‡’ pod ipê°€ ì•„ë‹Œ ì„œë¡œë¥¼ ë°œê²¬(Discovery)í•  ìˆ˜ ìˆëŠ” ë‹¤ë¥¸ ë°©ë²•ì´ í•„ìš”

### podê°€ ì™¸ë¶€ë¡œ ë…¸ì¶œí•˜ëŠ” ë°©ì‹

docker containerëŠ” -p(publish) ì˜µì…˜ìœ¼ë¡œ ì†ì‰½ê²Œ ì»¨í…Œì´ë„ˆë¥¼ ì™¸ë¶€ë¡œ ë…¸ì¶œ
â‡’ ì»¨í…Œì´ë„ˆê°€ ìƒì„±ë¨ê³¼ ë™ì‹œì— ì™¸ë¶€ë¡œ ë…¸ì¶œë˜ëŠ” ë°©ì‹

overlay ë„¤íŠ¸ì›Œí¬ë‚˜ docker ì‚¬ìš©ì ì •ì˜ ë„¤í¬ì›Œí¬, docker run â€”link ì˜µì…˜

â‡’ ì»¨í…Œì´ë„ˆë“¤ì´ ì„œë¡œë¥¼ ì´ë¦„ìœ¼ë¡œ ì ‘ê·¼í•  ìˆ˜ë„ ìˆìŒ

<aside>
ğŸ’¡ docker ë„¤íŠ¸ì›Œí¬ ì˜ˆ

```bash
docker run -d --name myapp -p 80:80 nginx:latest
docker run -itd --name myapp2 --link myapp:nginx ubuntu:16.04

docker network create mynetwork
docker run mycontainer --network mynetwork --net-alias mycon ubuntu:16.04
```

</aside>

kubernetesëŠ” podì— ì ‘ê·¼í•˜ë„ë¡ ì •ì˜í•˜ëŠ” ë°©ë²•ì´ dockerì™€ëŠ” ë‹¤ë¦„

docker run -p ëª…ë ¹ì–´ì™€ëŠ” ë‹¬ë¦¬ kubernetsëŠ” deploymentë¥¼ ìƒì„±í•  ë•Œ podë¥¼ ì™¸ë¶€ë¡œ ë…¸ì¶œí•˜ì§€ ì•ŠìŒdeploymentì˜ yaml íŒŒì¼ì—ëŠ” ë‹¨ì§€ podì˜ appì´ ì‚¬ìš©í•  ë‚´ë¶€ portë§Œ ì •ì˜

ì´ì „ì˜ nginx deploymentë¥¼ ìƒì„±í–ˆì„ ë•Œ ì‚¬ìš©í–ˆë˜ yaml íŒŒì¼ ì¤‘ì—ì„œ containerPort í•­ëª©

NginxëŠ” 80í¬íŠ¸ë¡œ ì›¹ ì„œë²„ë¥¼ ì œê³µí•˜ê¸° ë•Œë¬¸ì— containerPortì˜ ê°’ì„ 80ìœ¼ë¡œ ì„¤ì •

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-nginx-deployment
spec:
  replicas: 3
  selector:
    matchLabels:
      app: my-nginx
  template:
    metadata:
      name: my-nginx-pod
      labels:
        app: my-nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.10
        ports:
        **- containerPort: 80**
```

í•˜ì§€ë§Œ ë°”ë¡œ podê°€ ì™¸ë¶€ë¡œ ë…¸ì¶œë˜ì§„ ì•ŠìŒ â‡’ ì™¸ë¶€ ìœ ì €ë‚˜ í´ëŸ¬ìŠ¤í„°ì˜ podë“¤ì´ ì ‘ê·¼í•˜ê¸°ìœ„í•´ Serviceê°€ í•„ìš”í•¨

ServiceëŠ” podì— ì ‘ê·¼í•˜ê¸° ìœ„í•œ ê·œì¹™ì„ ì •ì˜

- ì—¬ëŸ¬ê°œì˜ podì— ì‰½ê²Œ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ê³ ìœ í•œ ë„ë©”ì¸ ì´ë¦„ì„ ë¶€ì—¬
- ì—¬ëŸ¬ ê°œì˜ podì— ì ‘ê·¼í•  ë•Œ, ìš”ì²­ì„ ë¶„ì‚°í•˜ëŠ” load balancer ê¸°ëŠ¥ì´ ìˆ˜í–‰
- í´ë¼ìš°ë“œ í”Œë«í¼ì˜ load balancer, cluster nodeì˜ port emddmf xhdgo podë¥¼ ì™¸ë¶€ë¡œ ë…¸ì¶œ
    - ClusterIP íƒ€ì…
        
        kubernetes ë‚´ë¶€ì—ì„œë§Œ podë“¤ì— ì ‘ê·¼í•  ë•Œ ì‚¬ìš©í•©ë‹ˆë‹¤. 
        
        ì™¸ë¶€ë¡œ podë¥¼ ë…¸ì¶œí•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— kubernetes clusterë‚´ë¶€ì—ì„œë§Œ ì‚¬ìš©ë˜ëŠ” podì— ì í•©
        
    - NodePort íƒ€ì…
        
        podì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” portë¥¼ clusterì˜ ëª¨ë“  nodeì— ë™ì¼í•˜ê²Œ ê°œë°©
        
        ì™¸ë¶€ì—ì„œ podì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ì„œë¹„ìŠ¤ íƒ€ì…
        
    - LoadBalancer íƒ€ì…
        
        í´ë¼ìš°ë“œ í”Œë«í¼ì—ì„œ ì œê³µí•˜ëŠ” ë¡œë“œë²¨ëŸ°ì„œë¥¼ ë™ì ìœ¼ë¡œ í”„ë¡œë¹„ì €ë‹í•´ íŒŒë“œì— ì—°ê²°
        
        ì™¸ë¶€ì—ì„œ íŒŒë“œì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ì„œë¹„ìŠ¤ íƒ€ì…
        

### ì„œë¹„ìŠ¤ ì‹¤ìŠµì„ ìœ„í•œ ì„œë²„ ë””í”Œë¡œì´

```bash
vi k8s_yaml/deployment-hostname.yaml
```

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hostname-deployment
spec:
  replicas: 3
  selector:
    matchLabels:
      app: webserver
  template:
    metadata:
      name: my-webserver
      labels:
        app: webserver
    spec:
      containers:
      - name: my-webserver
        image: alicek106/rr-test:echo-hostname
        ports:
        - containerPort: 80
```

```bash
kubectl apply -f k8s_yaml/deployment-hostname.yaml
```

```bash
kubectl get deploy
```

![Untitled](Service%20e205d12ad47647f787cd1027f98b2c63/Untitled.png)

# Cluster IP íƒ€ì…

```bash
vi k8s_yaml/hostname-svc-clusterip.yaml
```

```yaml
apiVersion: v1
kind: Service
metadata:
  name: hostname-svc-clusterip
spec:
  ports:
    - name: web-port
      port: 8080
      targetPort: 80
  selector:
    app: webserver
  type: ClusterIP
```

```bash
kubectl apply -f k8s_yaml/hostname-svc-clusterip.yaml
```

```bash
kubectl get service # kubectl get svc
```

![Untitled](Service%20e205d12ad47647f787cd1027f98b2c63/Untitled%201.png)

<aside>
ğŸ’¡ ë§Œë“ ì ë„ ì—†ëŠ” kubernetes ì„œë¹„ìŠ¤ëŠ” ë­˜ê¹Œìš”?
íŒŒë“œ ë‚´ë¶€ì—ì„œ ì¿ ë²„ë„¤í‹°ìŠ¤ APIì— ì ‘ê·¼í•˜ê¸° ìœ„í•œ ì„œë¹„ìŠ¤

</aside>

### í•´ë‹¹ IPì— ìš”ì²­ ë³´ë‚´ë³´ê¸°

```bash
kubectl run -i --tty --rm debug --image=alicek106/ubuntu:curl --restart=Never -- bash
```

![Untitled](Service%20e205d12ad47647f787cd1027f98b2c63/Untitled%202.png)

# NodePort íƒ€ì…

ì—¬ê¸°ì„œë¶€í„°ëŠ” ì™¸ë¶€ì—ì„œ ì ‘ì†ì´ ê°€ëŠ¥í•´ì§‘ë‹ˆë‹¤. 

```bash
vi k8s_yaml/hostname-svc-nodeport.yaml
```

```yaml
apiVersion: v1
kind: Service
metadata:
  name: hostname-svc-nodeport
spec:
  ports:
    - name: web-port
      port: 8080
      targetPort: 80
  selector:
    app: webserver
  type: NodePort
```

```bash
kubectl apply -f k8s_yaml/hostname-svc-nodeport.yaml
```

```bash
kubectl get svc
```

![Untitled](Service%20e205d12ad47647f787cd1027f98b2c63/Untitled%203.png)

```bash
kubectl get nodes -o wide
```

![Untitled](Service%20e205d12ad47647f787cd1027f98b2c63/Untitled%204.png)

```bash
curl EXTERNAL-IP:32527 # ë˜ëŠ” í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì—ì„œ INTERNAL-IP
```

![Untitled](Service%20e205d12ad47647f787cd1027f98b2c63/Untitled%205.png)

# LoadBalancer

ì„œë¹„ìŠ¤ì˜ ìƒì„±ê³¼ ë™ì‹œì— ìë™ìœ¼ë¡œ ë¡œë“œë²¨ëŸ°ì„œê°€ ìƒì„±ë˜ê³  ì´ê²ƒì´ podì™€ ì—°ê²°í•©ë‹ˆë‹¤.

nodeport íƒ€ì…ì—ì„œëŠ” ê° ë…¸ë“œì˜ INTERNAL /  EXTERNAL IPë¥¼ ì•Œì•„ì•¼ íŒŒë“œì— ì ‘ê·¼ì´ ê°€ëŠ¥

loadBalancerëŠ” í´ë¼ìš°ë“œ ì„œë¹„ìŠ¤ì—ì„œ ë„ë©”ì¸ ì´ë¦„ê³¼ IPë¥¼ í• ë‹¹ë°›ìŒ â‡’ ë”ìš± ì‰½ê²Œ ì ‘ê·¼ ê°€ëŠ¥

ë‹¨ loadBalancerë¥¼ ì§€ì›í•˜ëŠ” í´ë¼ìš°ë“œ í™˜ê²½ì—ì„œ ìˆì–´ì•¼ë§Œ ê°€ëŠ¥ AZURE AKS, AWS EKS, GCP GKE ë“±

ë˜ëŠ” kubeadmìœ¼ë¡œ on-prem í™˜ê²½ì˜ í´ëŸ¬ìŠ¤í„°ì§€ë§Œ AWS í´ë¼ìš°ë“œ í”„ë¡œë°”ì´ë”ë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜ Anthosë¥¼ ì“°ë©´ì„œ GKEì˜ ë¡œë“œë°¸ëŸ°ì„œì™€ ì—°ë™í•˜ëŠ” ê²½ìš°, Open Stackì˜ LBaaSë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš°

```bash
vi k8s_yaml/hostname-svc-lb.yaml
```

```yaml
apiVersion: v1
kind: Service
metadata:
  name: hostname-svc-lb
spec:
  ports:
    - name: web-port
      port: 80
      targetPort: 80
  selector:
    app: webserver
  type: LoadBalancer
```

```yaml
kubectl apply -f k8s_yaml/hostname-svc-lb.yaml
```

```bash
kubectl get svc
```

![Untitled](Service%20e205d12ad47647f787cd1027f98b2c63/Untitled%206.png)

![Untitled](Service%20e205d12ad47647f787cd1027f98b2c63/Untitled%207.png)

![Untitled](Service%20e205d12ad47647f787cd1027f98b2c63/Untitled%208.png)

![Untitled](Service%20e205d12ad47647f787cd1027f98b2c63/Untitled%209.png)

# ìš”ì²­ì„ ì™¸ë¶€ë¡œ ë¦¬ë””ë ‰íŠ¸ : ExternalName

ì™¸ë¶€ ì‹œìŠ¤í…œê³¼ ì—°ë™í•´ì•¼ í•  ë•Œ

ì„œë¹„ìŠ¤ê°€ ì™¸ë¶€ ë„ë§¤ì¸ì„ ê°€ë¦¬í‚¤ë„ë¡ ì„¤ì •

```bash
vi k8s_yaml/external-svc.yaml
```

```yaml
apiVersion: v1
kind: Service
metadata:
  name: externalname-svc
spec:
  type: ExternalName
  externalName: my.database.com
```

ìœ„ ì„¤ì •ì€ ì¿ ë²„ë„¤í‹°ìŠ¤ì˜ DNSëŠ” my.database.comìœ¼ë¡œ ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ CNAME ë ˆì½”ë“œ ë°˜í™˜

```bash
kubectl apply -f k8s_yaml/external-svc.yaml
```

```bash
kubectl get svc
```

![Untitled](Service%20e205d12ad47647f787cd1027f98b2c63/Untitled%2010.png)

# ì‹¤ìŠµí•œ ë¦¬ì†ŒìŠ¤ë“¤ ì •ë¦¬ - ì‚­ì œ

```bash
kubectl delete -f k8s_yaml/
```

![Untitled](Service%20e205d12ad47647f787cd1027f98b2c63/Untitled%2011.png)